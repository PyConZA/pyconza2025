{% extends "wafer/base.html" %}
{% load i18n %}
{% block title %}{% trans "Schedule" %} - {{ WAFER_CONFERENCE_NAME }}{% endblock %}

{% block page_title %}{% trans "Schedule" %}{% endblock %}

{% block content %}
<div class="lg:max-w-7xl mx-auto px-3">

  {% if user.is_authenticated and user.is_staff %}
    <div class="text-right mb-6 print:hidden">
      <a class="btn btn-secondary" href="{% url 'admin:schedule_editor' %}">
        {% trans "Edit schedule" %}
      </a>
    </div>
  {% endif %}

  {% if draft_warning %}
    <div class="alert alert-warning mb-6">
      <p class="font-semibold">{% trans "This is a draft that is not visible to the public" %}</p>
    </div>
  {% endif %}

  {% if not schedule_pages %}
    {# Show errors to authorised users (checked in get_context_data) #}
    {% if validation_errors %}
      <div class="alert alert-danger mb-6">
        <p class="font-semibold">{% trans "Validation errors:" %}</p>
        <ul class="mt-2">
          {% for validation_error in validation_errors %}
            <li>{{ validation_error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    {# Schedule is incomplete / invalid, so show nothing #}
    <div class="text-center py-12">
      {% blocktrans trimmed %}
        <p class="text-xl text-gray-600">The final schedule has not been published yet.</p>
      {% endblocktrans %}
    </div>
  {% else %}
    {% if next_block or prev_block %}
      <div class="flex justify-between mb-8 print:hidden">
        {% url 'wafer_full_schedule' as schedule_url %}
        {% if prev_block %}
          <a href="{{ schedule_url }}?block={{ prev_block.id }}" class="btn btn-secondary">
            ← {% trans "Previous" %}: {{ prev_block }}
          </a>
        {% else %}
          <div></div>
        {% endif %}
        {% if next_block %}
          <a href="{{ schedule_url }}?block={{ next_block.id }}" class="btn btn-secondary">
            {% trans "Next" %}: {{ next_block }} →
          </a>
        {% endif %}
      </div>
    {% endif %}

    <div class="space-y-8">
      {% for page in schedule_pages %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          {# Day header #}
          <div class="bg-pycon-blue text-white p-4">
            <h3 class="heading-light text-center">
              <a href="?block={{ page.block.id }}" class="text-white no-underline hover:underline">
                {{ page.block.start_time|date:"l, F d, Y" }}
              </a>
            </h3>
          </div>

          {# Desktop/Tablet Schedule table - hidden on mobile #}
          <div class="hidden md:block overflow-x-auto">
            <table class="w-full table-fixed min-w-[640px]">
              <colgroup>
                <col class="w-24 lg:w-32">
                {% for venue in page.venues %}
                  <col class="flex-1">
                {% endfor %}
              </colgroup>
              <thead class="bg-gray-100">
                <tr>
                  <th class="text-center p-2 lg:p-4 font-semibold text-gray-700 border-r border-gray-200 text-sm lg:text-base">
                    {% trans "Time" %}
                  </th>
                  {% for venue in page.venues %}
                    <th class="text-center p-2 lg:p-4 font-semibold text-gray-700 border-r border-gray-200 last:border-r-0 text-sm lg:text-base
                       {% if venue.pk == highlight_venue_pk %}bg-pycon-blue/10{% endif %}">
                      <a href="{{ venue.get_absolute_url }}" class="text-pycon-blue hover:underline">
                        {{ venue.name }}
                      </a>
                    </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                {% for row in page.rows %}
                  <tr class="hover:bg-gray-50">
                    <td class="p-2 lg:p-4 font-medium text-gray-800 border-r border-gray-200 bg-gray-50/50 whitespace-nowrap text-center text-xs lg:text-sm">
                      {{ row.slot.get_start_time|time:"H:i" }} - {{ row.slot.end_time|time:"H:i" }}
                    </td>
                    {% for item in row.get_sorted_items %}
                      {% if item.item == "unavailable" %}
                        <td colspan="{{ item.colspan }}" rowspan="{{ item.rowspan }}"
                            class="p-2 lg:p-4 bg-gray-100 border-r border-gray-200 last:border-r-0 text-center"></td>
                      {% else %}
                        <td colspan="{{ item.colspan }}" rowspan="{{ item.rowspan }}"
                            class="p-2 lg:p-4 border-r border-gray-200 last:border-r-0 text-center text-xs lg:text-sm {{ item.item.get_css_classes|join:' ' }}
                            {% if item.item.venue.pk == highlight_venue_pk %}bg-pycon-blue/5{% endif %}">
                          {% include "wafer.schedule/schedule_item.html" with item=item.item %}
                        </td>
                      {% endif %}
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {# Mobile card-based layout #}
          <div class="md:hidden divide-y divide-gray-200">
            {% for row in page.rows %}
              <div class="p-4 space-y-3">
                <div class="flex items-center justify-between mb-3">
                  <span class="font-semibold text-pycon-blue text-sm">
                    {{ row.slot.get_start_time|time:"H:i" }} - {{ row.slot.end_time|time:"H:i" }}
                  </span>
                </div>

                {% for item in row.get_sorted_items %}
                  {% if item.item != "unavailable" %}
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 {{ item.item.get_css_classes|join:' ' }}
                         {% if item.item.venue.pk == highlight_venue_pk %}ring-2 ring-pycon-blue/30{% endif %}">
                      <div class="text-xs font-semibold text-pycon-blue mb-1">
                        {% for venue in page.venues %}
                          {% if venue == item.item.venue %}
                            <a href="{{ venue.get_absolute_url }}" class="hover:underline">
                              {{ venue.name }}
                            </a>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="text-sm text-gray-800">
                        {% include "wafer.schedule/schedule_item.html" with item=item.item %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}
